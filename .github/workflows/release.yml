name: Release

on:
  workflow_dispatch:
    inputs:
      fromVersion:
        description: "Base Version (e.g., v0.9.0)"
        required: true
        type: string
      version:
        description: "Version (e.g., v1.0.0)"
        required: true
        type: string

permissions:
  contents: write # Required for creating releases and tags

jobs:
  validate:
    name: Validate Branch
    runs-on: ubuntu-latest
    steps:
      - name: Check branch is main
        if: github.ref != 'refs/heads/main'
        run: |
          echo "âŒ This workflow can only be run on main branch"
          echo "Current ref: ${{ github.ref }}"
          exit 1

      - name: Validate version format
        run: |
          if ! echo "${{ github.event.inputs.version }}" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
            echo "âŒ Invalid version format: ${{ github.event.inputs.version }}"
            echo "Expected format: v1.0.0 or v1.0.0-beta.1"
            exit 1
          fi
          echo "âœ… Version format valid: ${{ github.event.inputs.version }}"

  changelog:
    name: Generate Changelog
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.generate.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for changelog generation

      - name: Generate changelog
        id: generate
        uses: requarks/changelog-action@v1
        with:
          token: ${{ github.token }}
          # tag: ${{ github.event.inputs.version }}
          fromTag: ${{ github.event.inputs.version }}
          toTag: ${{ github.event.inputs.fromVersion }}
          includeInvalidCommits: false
          writeToFile: true
          excludeTypes: ""

      - name: Commit CHANGELOG.md
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          commit_message: "docs: update CHANGELOG.md for ${{ github.ref_name }} [skip ci]"
          file_pattern: CHANGELOG.md

  build:
    name: Build ${{ matrix.artifact_name }}
    needs: changelog
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            build_tags: sqlcipher,linux
            artifact_name: shed-linux-amd64
            cc: gcc

          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            goos: darwin
            goarch: arm64
            build_tags: sqlcipher,darwin
            artifact_name: shed-darwin-arm64
            cc: clang

          # macOS AMD64 (Intel) - Cross-compiled from ARM64
          - os: macos-latest
            goos: darwin
            goarch: amd64
            build_tags: sqlcipher,darwin
            artifact_name: shed-darwin-amd64
            cc: clang

          # Windows AMD64
          - os: windows-latest
            goos: windows
            goarch: amd64
            build_tags: sqlcipher,windows
            artifact_name: shed-windows-amd64.exe
            cc: gcc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.1"

      # Linux dependencies
      - name: Install dependencies (Linux)
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev build-essential

      # macOS dependencies
      - name: Install dependencies (macOS ARM64)
        if: matrix.goos == 'darwin' && matrix.goarch == 'arm64'
        run: |
          brew install sqlcipher

      - name: Install dependencies (macOS AMD64)
        if: matrix.goos == 'darwin' && matrix.goarch == 'amd64'
        run: |
          # Install Rosetta 2 for x86_64 emulation
          softwareupdate --install-rosetta --agree-to-license || true

          # Check if x86_64 Homebrew exists, if not install it
          if [ ! -f /usr/local/bin/brew ]; then
            arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # Install x86_64 version of sqlcipher
          arch -x86_64 /usr/local/bin/brew install sqlcipher

          # Set up CGO to use x86_64 libraries
          echo "CGO_CFLAGS=-arch x86_64 -I/usr/local/opt/sqlcipher/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-arch x86_64 -L/usr/local/opt/sqlcipher/lib" >> $GITHUB_ENV

      # Windows dependencies
      - name: Setup MSYS2 (Windows)
        if: matrix.goos == 'windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-sqlcipher

      - name: Set Windows environment
        if: matrix.goos == 'windows'
        shell: msys2 {0}
        run: |
          echo "CGO_CFLAGS=-ID:/a/_temp/msys64/mingw64/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-LD:/a/_temp/msys64/mingw64/lib" >> $GITHUB_ENV

      - name: Build binary
        shell: bash
        env:
          CGO_ENABLED: 1
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CC: ${{ matrix.cc }}
        run: |
          go build \
            -tags="${{ matrix.build_tags }}" \
            -ldflags="-X h3jfc/shed/cmd.Commit=${{ github.sha }} -X h3jfc/shed/cmd.Version=${{ github.event.inputs.version }}" \
            -o ${{ matrix.artifact_name }} \
            main.go

      - name: Verify binary
        if: matrix.goos != 'windows'
        run: |
          file ${{ matrix.artifact_name }}
          ls -lh ${{ matrix.artifact_name }}

      - name: Verify binary (Windows)
        if: matrix.goos == 'windows'
        shell: pwsh
        run: |
          Get-Item ${{ matrix.artifact_name }} | Format-List

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}
          retention-days: 1
          if-no-files-found: error

  release:
    name: Create Release
    needs: [changelog, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: |
          ls -R artifacts/
          echo "---"
          find artifacts -type f -exec ls -lh {} \;

      - name: Flatten artifacts directory
        run: |
          mkdir -p release-artifacts
          find artifacts -type f -exec cp {} release-artifacts/ \;
          ls -lh release-artifacts/

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "release-artifacts/*"
          body: ${{ needs.changelog.outputs.changelog }}
          tag: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          draft: false
          prerelease: ${{ contains(github.event.inputs.version, '-') }}
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: true

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- shed-linux-amd64" >> $GITHUB_STEP_SUMMARY
          echo "- shed-darwin-amd64" >> $GITHUB_STEP_SUMMARY
          echo "- shed-darwin-arm64" >> $GITHUB_STEP_SUMMARY
          echo "- shed-windows-amd64.exe" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }})" >> $GITHUB_STEP_SUMMARY
